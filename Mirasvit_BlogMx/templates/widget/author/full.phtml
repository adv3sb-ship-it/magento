<?php
declare(strict_types=1);

/** @var \Mirasvit\BlogMx\Block\Widget\Author $block */

$author = $block->getAuthor();
if (!$author) {
    return null;
}

$authorView = $block->getAuthorView();

$socialLinks = [];
foreach ($block->getSocialLinks() as $social) {
    if ($social['link']) {
        $socialLinks[] = $social;
    }
}

$storeManager = \Magento\Framework\App\ObjectManager::getInstance()
    ->get(\Magento\Store\Model\StoreManagerInterface::class);
$orgName = $storeManager->getStore()->getFrontendName();

// Отримуємо оригінальне ім'я автора
$originalAuthorName = $author->getName();

// Спробуємо отримати переклад імені автора
$translatedName = (string) __($originalAuthorName);

// Якщо переклад не знайдено (повернулось те ж саме значення),
// можна спробувати альтернативні методи
if ($translatedName === $originalAuthorName) {
    $authorNameKey = 'author_name_' . strtolower(str_replace(' ', '_', $originalAuthorName));
    $alternativeTranslation = (string) __($authorNameKey);

    if ($alternativeTranslation !== $authorNameKey) {
        $translatedName = $alternativeTranslation;
    }
}

// A) H1 на сторінці
if ($mainTitle = $block->getLayout()->getBlock('page.main.title')) {
    $mainTitle->setPageTitle($translatedName);
}

// B) <title> у <head>
if ($headBlock = $block->getLayout()->getBlock('head')) {
    $headBlock->setTitle($translatedName);
}

// Ключ для fullbio_{slug}
$filter = \Magento\Framework\App\ObjectManager::getInstance()
    ->get(\Magento\Framework\Filter\FilterManager::class);
$nameSlug = $filter->translitUrl((string)$author->getName());
if (!$nameSlug) {
    $nameSlug = 'author_' . (int)$author->getId();
}
$nameSlug = str_replace('-', '_', $nameSlug); 
$fullBioKey = 'fullbio_' . $nameSlug;
?>

<div class="author-promo">
    <div class="flex">
        <div class="author-promo-wrap">
            <span class="title"><?= $block->escapeHtml($translatedName) ?></span>
            <?php if ($imageUrl = $authorView->getImageUrl($author)): ?>
                <div class="author-promo-logo">
                    <img loading="lazy" src="<?= $imageUrl ?>" alt="<?= $block->escapeHtmlAttr($translatedName); ?>">
                </div>
            <?php endif ?>
        </div>
        <div class="author-promo-cont">
            <span class="title"><?= $block->escapeHtml($translatedName) ?></span>
            <?php if ($author->getJobTitle()): ?>
                <p class="bmx:text-subdued bmx:text-sm"><?= $block->escapeHtml((string) __($author->getJobTitle())) ?></p>
            <?php endif ?>
            <div class="bmx:text-sm">
                <?= /* @noEscape */ $block->escapeHtml(
                    (string) __($fullBioKey),
                    // дозволені теги
                    ['br','strong','em','b','i','u','a','p','ul','ol','li','span','h2','h3','h4'],
                    // дозволені атрибути
                    ['href','title','target','rel','class']
                ) ?>
            </div>

            <?php if (count($socialLinks) > 0): ?>
                <div class="link-row">
                    <div class="social">
                        <span><?= __('Subscribe to the author') ?>:</span>
                        <ul>
                            <?php foreach ($socialLinks as $social): ?>
                                <li>
                                    <a href="<?= $social['link'] ?>">
                                        <img
                                            src="<?= $block->getViewFileUrl('images/triniti-img-icon/' . mb_strtolower($social['label']) . '-soc.svg'); ?>"
                                            alt="<?= $block->escapeHtmlAttr($social['label']) ?>">
                                    </a>
                                </li>
                            <?php endforeach ?>
                        </ul>
                    </div>
                </div>
            <?php endif ?>
        </div>
    </div>
</div>

<script type="application/ld+json">
<?= json_encode([
    '@context' => 'https://schema.org/',
    '@type' => 'Person',
    'name' => $translatedName,
    'url' => $authorView->getUrl($author),
    'image' => $authorView->getImageUrl($author),
    'jobTitle' => (string) __($author->getJobTitle()),
    'worksFor' => [
        '@type' => 'Organization',
        'name' => $orgName,
    ],
    'sameAs' => array_filter(array_column($socialLinks, 'link')),
], JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES | JSON_PRETTY_PRINT) ?>
</script>